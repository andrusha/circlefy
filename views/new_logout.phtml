<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta http-equiv="Content-Language" content="EN" />
<meta name="ROBOTS" content="ALL" />
<meta name="Copyright" content="Copyright (c) 2009 TAP" />
<meta http-equiv="imagetoolbar" content="false" />
<meta name="description" content="TAP communication platform" />
<meta name="keywords" content="real-time, search, TAP, microblogging, communication platform" />

<title>TAP :: BETA</title>

<link rel="shortcut icon" href="/images/cimages/favicon.ico" type="image/x-icon" />
<link rel="icon" href="/images/cimages/favicon.ico" type="image/x-icon" />
<link rel="stylesheet" href="views/style_sheets/group_manage.css" type="text/css" />
<link rel="stylesheet" href="views/style_sheets/homepage.css" type="text/css" />
<script type="text/javascript" src="views/javascript/mootools-1.2.3-core-yc.js"></script>
<script type="text/javascript" src="views/javascript/mootools-1.2.3.1-more.js"></script>
<script type="text/javascript" src="views/javascript/mootools-tap.js"></script>
<script type="text/javascript" src="http://mark.tap.info:8000/static/Orbited.js"></script>
<script type="text/javascript">
Tap = window.Tap || {};

Tap.Main = {

	init: function(){
		var self = this;

		$('login').addEvent('submit', this.onLogin.toHandler(this));

		var signUp = $('signup-form');
		var data = this.data = {
			user: signUp.getElement('input[name="user"]'),
			name: signUp.getElement('input[name="name"]'),
			email: signUp.getElement('input[name="email"]'),
			pass: signUp.getElement('input[name="pass"]'),
			passrepeat: signUp.getElement('input[name="passrepeat"]')
		};
		data.user.addEvent('blur', this.checkUser.toHandler(this));
		data.name.addEvent('blur', this.checkName.toHandler(this));
		data.email.addEvent('blur', this.checkEmail.toHandler(this));
		data.pass.addEvent('blur', this.checkPass.toHandler(this));
		data.passrepeat.addEvent('blur', this.checkPassRepeat.toHandler(this));
		$('signup-submit').addEvent('click', this.onSignup.toHandler(this));
	},

	onLogin: function(el, e){
		e.stop();
		var errors = false;
		var user = $('uname');
		var pass = $('pass');
		if (user.isEmpty()) {
			user.addClass('input-err');
			errors = true;
		} else {
			user.removeClass('input-err');
		}
		if (pass.isEmpty()) {
			pass.addClass('input-err');
			errors = true;
		} else {
			pass.removeClass('input-err');
		}
		if (errors) return;
		el.submit();
	},

	checkUser: function(el){
		var self = this;
		if (el.isEmpty() || !el.ofLength(4, 20)) {
			return this.showError(el, 'Username must be at least 4 characters');
		} else {
			new Request({
				url: 'AJAX/check_signup.php',
				data: {
					type: 1,
					val: el.get('value')
				},
				onSuccess: function(){
					var response = JSON.decode(this.response.text);
					if (!response.available) {
						self.showError(el, 'This username is already taken.');
					} else {
						self.removeError(el);
					}
				}
			}).send();
		}
		return this.removeError(el);
	},

	checkName: function(el){
		if (el.isEmpty()) {
			return this.showError(el, 'Please enter a name.');
		}
		return this.removeError(el);
	},

	checkEmail: function(el){
		var self = this;
		if (el.isEmpty() || !el.isEmail()) {
			return this.showError(el, 'Please enter a valid email.');
		} else {
			new Request({
				url: 'AJAX/check_signup.php',
				data: {
					type: 2,
					val: el.get('value')
				},
				onSuccess: function(){
					var response = JSON.decode(this.response.text);
					if (!response.available) {
						self.showError(el, 'This email is already used.');
					} else {
						self.removeError(el);
					}
				}
			}).send();
		}
		return this.removeError(el);
	},

	checkPass: function(el){
		if (el.isEmpty() || !el.ofLength(6, 20)) {
			return this.showError(el, 'Password must be at least 6 characters.');
		}
		return this.removeError(el);
	},

	checkPassRepeat: function(el){
		var data = this.data;
		if (el.isEmpty()) {
			return this.showError(el, 'Repeat your password.');
		} else if (el.get('value') !== data.pass.get('value')) {
			return this.showError(el, 'Your passwords don\'t match.');
		}
		return this.removeError(el);
	},

	showError: function(el, error){
		var msg = el.getNext('div.guide');
		msg.set('text', error);
		msg.setStyle('display', 'block');
		el.addClass('input-err');
		el.store('passed', false);
		return this;
	},

	removeError: function(el){
		var msg = el.getNext('div.guide');
		msg.setStyle('display', 'none');
		el.removeClass('input-err');
		el.store('passed', true);
		return this;
	},

	noErrors: function(){
		return !$H(this.data).getValues().map(function(item){
			return !!item.retrieve('passed');
		}).contains(false);
	},

	onSignup: function(el, e){
		var data = this.data;
		if (this.noErrors()) {
			new Request({
				url: 'AJAX/ajaz_sign_up.php',
				data: {
					uname: data.user.get('value'),
					fname: data.name.get('value'),
					email: data.email.get('value'),
					pass: data.pass.get('value'),
					fid: 0,
					signup_flag: 'signup_function();'
				},
				onSuccess: function(){
					window.location.reload();
				}
			}).send();
		} else {
			$$($H(data).getValues().filter(function(item){
				return !item.retrieve('passed');
			})).fireEvent('blur', [e]);
		}
	}
};

window.addEvent('domready', Tap.Main.init.bind(Tap.Main));
</script>
</head>

<body>

	<?php include(LOGOUT_HEADER); ?>

	<div id="main">

		<div id="right-col">
			<h1>What's This?</h1>
			<p>Tap allows you to connect with people around you and stay informed about topics you're interested in.  Use Tap to see what you and your friends are doing, what people around you are doing, and connect with link-minded individuals. Join Tap today!</p>
		</div>

		<div id="center-col">

			<?php if (!empty($_t['errors'])): ?>
			<div class="section error">
				<?= $_t['errors'] ?>
			</div>
			<?php endif; ?>

			<div id="tap-feed" class="section">
				<div class="section-head">
					<h1>
						<img id="tap-feed-icon" src="/group_pics/36wh_default_group.gif" style="float:left; margin-right:10px; height: 20px; width: 20px" />
						<span id="tap-feed-name">Look Who's Tapping!</span>
					</h1>
				</div>
				<div class="section-body">
					<ul id="main-stream" class="tap-stream">
						<?php
							if (!empty($_t['groups_bits'])):
								foreach($_t['groups_bits'] as $bit):
						?>
						<li id="tid_<?= $bit['cid'] ?>">
							<img src="/user_pics/<?= $bit['pic_100'] ?>" class="avatar" alt="<?= $bit['uname'] ?>" />
							<div class="tap-actions">
								<a class="tap-respond" href="#">Respond</a>
							</div>
							<div class="tap-body">
								<p class="tap-info">
									<span class="tap-from"><?= $bit['fname'] . " " . $bit['lname'] ?></span>
									<span class="tap-time <?= $bit['chat_timestamp_raw'] ?>"><?= $bit['chat_timestamp'] ?></span>
									<span class="tap-typing"></span>
								</p>
								<p>
									<span class="tap-msg"><?= $bit['chat_text'] ?></span>
								</p>
							</div>
							<div class="tap-response-box clarity">
								<ul class="tap-chat">
								</ul>
								<input type="text" class="tap-response" style="width:450px" />
								<!-- <a href="#">Respond</a> or  --><a class="tap-respond-cancel" href="#">Close</a>
							</div>
							<div class="clarity"></div>
						</li>
						<?php
								endforeach;
							else:
						?>
						<li class="noresults">
							<p>This feed is too silent. Try sending a tap!</p>
						</li>
						<?php
							endif;
						?>
					</ul>
				</div>
			</div>
		</div>

		<div id="left-col">
			<div id="groups-tab">
				<div class="tab-in" style="color:#fff">Log in</div>
			</div>
			<div class="tab-list">
				<form id="login" action="<?=ROOT?>" method="POST">
					<label>Username</label>
						<input type="text" id="uname" name="uname" class="text" />
					<label>Password</label>
						<input type="password" id="pass" name="pass" class="text" />
					<br/>
					<input type="checkbox" checked="true" id="auto_login" name="auto_login" />
					<label class="in-form">Keep Me Logged In</label>
					<input type="submit" id="signin_submit" value="Sign In" />
				</form>
			</div>

			<div id="signup-tab">Sign-up
				<div id="signup-title">Its very easy<br />and it wont take you<br />more than 45 seconds.</div>
			</div>
			<div id="signup-form">
				<label>Username</label>
					<input type="text" name="user" class="text"/>
					<div class="guide">No spaces</div>
				<label>Full Name</label>
					<input type="text" name="name" class="text"/>
					<div class="guide">6 characters or more</div>
				<label>E-mail</label>
					<input type="text" name="email" class="text"/>
				<label>Password</label>
					<input type="password" name="pass" class="text"/>
					<div class="guide">6 characters or more</div>
				<label>Retype Password</label>
					<input type="password" name="passrepeat" class="text"/>
				<input type="submit" id="signup-submit" value="Sign me up!" />
			</div>
		</div>

	</div>

	<div id="footer">

	</div>

</body>
</html>
