/*
Script: TextboxList.js
	Displays a textbox as a combination of boxes an inputs (eg: facebook tokenizer)

Authors:
	Guillermo Rauch
*/

var TextboxList=new Class({Implements:[Options,Events],plugins:[],options:{prefix:"textboxlist",max:null,unique:false,uniqueInsensitive:true,endEditableBit:true,startEditableBit:true,hideEditableBits:true,inBetweenEditableBits:true,keys:{previous:Event.Keys.left,next:Event.Keys.right},bitsOptions:{editable:{},box:{}},plugins:{},check:function(a){return a.clean().replace(/,/g,"")!="";},encode:function(a){return a.map(function(b){b=($chk(b[0])?b[0]:b[1]);return $chk(b)?b:null;}).clean().join(",");},decode:function(a){return a.split(",");}},initialize:function(c,b){this.setOptions(b);this.original=$(c).setStyle("display","none").set("autocomplete","off").addEvent("focus",this.focusLast.bind(this));this.container=new Element("div",{"class":this.options.prefix}).inject(c,"after");this.container.addEvent("click",function(d){if((d.target==this.list||d.target==this.container)&&(!this.focused||$(this.current)!=this.list.getLast())){this.focusLast();}}.bind(this));this.list=new Element("ul",{"class":this.options.prefix+"-bits"}).inject(this.container);for(var a in this.options.plugins){this.enablePlugin(a,this.options.plugins[a]);}["check","encode","decode"].each(function(d){this.options[d]=this.options[d].bind(this);},this);this.afterInit();},enablePlugin:function(b,a){this.plugins[b]=new TextboxList[b.camelCase().capitalize()](this,a);},afterInit:function(){if(this.options.unique){this.index=[];}if(this.options.endEditableBit){this.create("editable",null,{tabIndex:this.original.tabIndex}).inject(this.list);}var a=this.update.bind(this);this.addEvent("bitAdd",a,true).addEvent("bitRemove",a,true);document.addEvents({click:function(c){if(!this.focused){return;}if(c.target.className.contains(this.options.prefix)){if(c.target==this.container){return;}var b=c.target.getParent("."+this.options.prefix);if(b==this.container){return;}}this.blur();}.bind(this),keydown:function(c){if(!this.focused||!this.current){return;}var f=this.current.is("editable")?this.current.getCaret():null;var e=this.current.getValue()[1];var b=["shift","alt","meta","ctrl"].some(function(g){return c[g];});var d=b||(this.current.is("editable")&&this.current.isSelected());switch(c.code){case Event.Keys.backspace:if(this.current.is("box")){c.stop();return this.current.remove();}case this.options.keys.previous:if(this.current.is("box")||((f==0||!e.length)&&!d)){c.stop();this.focusRelative("previous");}break;case Event.Keys["delete"]:if(this.current.is("box")){c.stop();return this.current.remove();}case this.options.keys.next:if(this.current.is("box")||(f==e.length&&!d)){c.stop();this.focusRelative("next");}}}.bind(this)});this.setValues(this.options.decode(this.original.get("value")));},create:function(a,c,b){if(a=="box"){if((!c[0]&&!c[1])||($chk(c[1])&&!this.options.check(c[1]))){return false;}if($chk(this.options.max)&&this.list.getChildren("."+this.options.prefix+"-bit-box").length+1>this.options.max){return false;}if(this.options.unique&&this.index.contains(this.uniqueValue(c))){return false;}}return new TextboxListBit[a.capitalize()](c,this,$merge(this.options.bitsOptions[a],b));},uniqueValue:function(a){return $chk(a[0])?a[0]:(this.options.uniqueInsensitive?a[1].toLowerCase():a[1]);},onFocus:function(a){if(this.current){this.current.blur();}$clear(this.blurtimer);this.current=a;this.container.addClass(this.options.prefix+"-focus");if(!this.focused){this.focused=true;this.fireEvent("focus",a);}},onBlur:function(b,a){this.current=null;this.container.removeClass(this.options.prefix+"-focus");this.blurtimer=this.blur.delay(a?0:200,this);},onAdd:function(d){if(this.options.unique&&d.is("box")){this.index.push(this.uniqueValue(d.value));}if(d.is("box")){var c=this.getBit($(d).getPrevious());if((c&&c.is("box")&&this.options.inBetweenEditableBits)||(!c&&this.options.startEditableBit)){var a=this.create("editable").inject(c||this.list,c?"after":"top");if(this.options.hideEditableBits){a.hide();}}}},onRemove:function(b){if(!this.focused){return;}if(this.options.unique&&b.is("box")){this.index.erase(this.uniqueValue(b.value));}var a=this.getBit($(b).getPrevious());if(a&&a.is("editable")){a.remove();}this.focusRelative("next",b);},focusRelative:function(c,d){var a=this.getBit($($pick(d,this.current))["get"+c.capitalize()]());if(a){a.focus();}return this;},focusLast:function(){var a=this.list.getLast();if(a){this.getBit(a).focus();}return this;},blur:function(){if(!this.focused){return this;}if(this.current){this.current.blur();}this.focused=false;return this.fireEvent("blur");},add:function(d,f,c,e){var a=this.create("box",[f,d,c]);if(a){if(!e){e=this.list.getLast("."+this.options.prefix+"-bit-box");}a.inject(e||this.list,e?"after":"top");}return this;},getBit:function(a){return($type(a)=="element")?a.retrieve("textboxlist:bit"):a;},getValues:function(){return this.list.getChildren().map(function(a){var b=this.getBit(a);if(b.is("editable")){return null;}return b.getValue();},this).clean();},setValues:function(a){if(!a){return;}a.each(function(b){if(b){this.add.apply(this,$type(b)=="array"?[b[1],b[0],b[2]]:[b]);}},this);},update:function(){this.original.set("value",this.options.encode(this.getValues()));}});var TextboxListBit=new Class({Implements:Options,initialize:function(c,b,a){this.name=this.type.capitalize();this.value=c;this.textboxlist=b;this.setOptions(a);this.prefix=this.textboxlist.options.prefix+"-bit";this.typeprefix=this.prefix+"-"+this.type;this.bit=new Element("li").addClass(this.prefix).addClass(this.typeprefix).store("textboxlist:bit",this);this.bit.addEvents({mouseenter:function(){this.bit.addClass(this.prefix+"-hover").addClass(this.typeprefix+"-hover");}.bind(this),mouseleave:function(){this.bit.removeClass(this.prefix+"-hover").removeClass(this.typeprefix+"-hover");}.bind(this)});},inject:function(b,a){this.bit.inject(b,a);this.textboxlist.onAdd(this);return this.fireBitEvent("add");},focus:function(){if(this.focused){return this;}this.show();this.focused=true;this.textboxlist.onFocus(this);this.bit.addClass(this.prefix+"-focus").addClass(this.prefix+"-"+this.type+"-focus");return this.fireBitEvent("focus");},blur:function(){if(!this.focused){return this;}this.focused=false;this.textboxlist.onBlur(this);this.bit.removeClass(this.prefix+"-focus").removeClass(this.prefix+"-"+this.type+"-focus");return this.fireBitEvent("blur");},remove:function(){this.blur();this.textboxlist.onRemove(this);this.bit.destroy();return this.fireBitEvent("remove");},show:function(){this.bit.setStyle("display","block");return this;},hide:function(){this.bit.setStyle("display","none");return this;},fireBitEvent:function(a){a=a.capitalize();this.textboxlist.fireEvent("bit"+a,this).fireEvent("bit"+this.name+a,this);return this;},is:function(a){return this.type==a;},setValue:function(a){this.value=a;return this;},getValue:function(){return this.value;},toElement:function(){return this.bit;}});TextboxListBit.Editable=new Class({Extends:TextboxListBit,options:{tabIndex:null,growing:true,growingOptions:{},stopEnter:true,addOnBlur:false,addKeys:Event.Keys.enter},type:"editable",initialize:function(c,b,a){this.parent(c,b,a);this.element=new Element("input",{type:"text","class":this.typeprefix+"-input",autocomplete:"off",value:this.value?this.value[1]:""}).inject(this.bit);if($chk(this.options.tabIndex)){this.element.tabIndex=this.options.tabIndex;}if(this.options.growing){new GrowingInput(this.element,this.options.growingOptions);}this.element.addEvents({focus:function(){this.focus(true);}.bind(this),blur:function(){this.blur(true);if(this.options.addOnBlur){this.toBox();}}.bind(this)});if(this.options.addKeys||this.options.stopEnter){this.element.addEvent("keydown",function(d){if(!this.focused){return;}if(this.options.stopEnter&&d.code===Event.Keys.enter){d.stop();}if($splat(this.options.addKeys).contains(d.code)){d.stop();this.toBox();}}.bind(this));}},hide:function(){this.parent();this.hidden=true;return this;},focus:function(a){this.parent();if(!a){this.element.focus();}return this;},blur:function(a){this.parent();if(!a){this.element.blur();}if(this.hidden&&!this.element.value.length){this.hide();}return this;},getCaret:function(){if(this.element.createTextRange){var a=document.selection.createRange().duplicate();a.moveEnd("character",this.element.value.length);if(a.text===""){return this.element.value.length;}return this.element.value.lastIndexOf(a.text);}else{return this.element.selectionStart;}},getCaretEnd:function(){if(this.element.createTextRange){var a=document.selection.createRange().duplicate();a.moveStart("character",-this.element.value.length);return a.text.length;}else{return this.element.selectionEnd;}},isSelected:function(){return this.focused&&(this.getCaret()!==this.getCaretEnd());},setValue:function(a){this.element.value=$chk(a[0])?a[0]:a[1];if(this.options.growing){this.element.retrieve("growing").resize();}return this;},getValue:function(){return[null,this.element.value,null];},toBox:function(){var c=this.getValue();var a=this.textboxlist.create("box",c);if(a){a.inject(this.bit,"before");this.setValue([null,"",null]);return a;}return null;}});TextboxListBit.Box=new Class({Extends:TextboxListBit,options:{deleteButton:true},type:"box",initialize:function(c,b,a){this.parent(c,b,a);this.bit.set("html",$chk(this.value[2])?this.value[2]:this.value[1]);this.bit.addEvent("click",this.focus.bind(this));if(this.options.deleteButton){this.bit.addClass(this.typeprefix+"-deletable");this.close=new Element("a",{href:"#","class":this.typeprefix+"-deletebutton",events:{click:this.remove.bind(this)}}).inject(this.bit);}this.bit.getChildren().addEvent("click",function(d){d.stop();});}});(function(){TextboxList.Autocomplete=new Class({Implements:Options,options:{minLength:1,maxResults:10,insensitive:true,highlight:true,highlightSelector:null,mouseInteraction:true,onlyFromValues:false,queryRemote:false,remote:{url:"",param:"search",extraParams:{},loadPlaceholder:"Please wait..."},method:"standard",placeholder:"Type to receive suggestions"},initialize:function(b,a){this.setOptions(a);this.textboxlist=b;this.textboxlist.addEvent("bitEditableAdd",this.setupBit.bind(this),true).addEvent("bitEditableFocus",this.search.bind(this),true).addEvent("bitEditableBlur",this.hide.bind(this),true).setOptions({bitsOptions:{editable:{addKeys:[],stopEnter:false}}});if(Browser.Engine.trident){this.textboxlist.setOptions({bitsOptions:{editable:{addOnBlur:false}}});}if(this.textboxlist.options.unique){this.index=[];this.textboxlist.addEvent("bitBoxRemove",function(c){if(c.autoValue){this.index.erase(c.autoValue);}}.bind(this),true);}this.prefix=this.textboxlist.options.prefix+"-autocomplete";this.method=TextboxList.Autocomplete.Methods[this.options.method];this.container=new Element("div",{"class":this.prefix}).setStyle("width",this.textboxlist.container.getStyle("width")).inject(this.textboxlist.container);if($chk(this.options.placeholder)||this.options.queryServer){this.placeholder=new Element("div",{"class":this.prefix+"-placeholder"}).inject(this.container);}this.list=new Element("ul",{"class":this.prefix+"-results"}).inject(this.container);this.list.addEvent("click",function(c){c.stop();});this.values=this.results=this.searchValues=[];this.navigate=this.navigate.bind(this);},setValues:function(a){this.values=a;},setupBit:function(a){a.element.addEvent("keydown",this.navigate,true).addEvent("keyup",function(){this.search();}.bind(this),true);},search:function(d){if(d){this.currentInput=d;}if(!this.options.queryRemote&&!this.values.length){return;}var a=this.currentInput.getValue()[1];if(a.length<this.options.minLength){this.showPlaceholder(this.options.placeholder);}if(a==this.currentSearch){return;}this.currentSearch=a;this.list.setStyle("display","none");if(a.length<this.options.minLength){return;}if(this.options.queryRemote){if(this.searchValues[a]){this.values=this.searchValues[a];}else{var c=this.options.remote.extraParams,b=this;if($type(c)=="function"){c=c.run([],this);}c[this.options.remote.param]=a;if(this.currentRequest){this.currentRequest.cancel();}this.currentRequest=new Request.JSON({url:this.options.remote.url,data:c,onRequest:function(){b.showPlaceholder(b.options.remote.loadPlaceholder);},onSuccess:function(e){b.searchValues[a]=e;b.values=e;b.showResults(a);}}).send();}}if(this.values.length){this.showResults(a);}},showResults:function(b){var a=this.method.filter(this.values,b,this.options.insensitive,this.options.maxResults);if(this.index){a=a.filter(function(c){return !this.index.contains(c);},this);}this.hidePlaceholder();if(!a.length){return;}this.blur();this.list.empty().setStyle("display","block");a.each(function(c){this.addResult(c,b);},this);if(this.options.onlyFromValues){this.focusFirst();}this.results=a;},addResult:function(c,b){var a=new Element("li",{"class":this.prefix+"-result",html:$pick(c[3],c[1])}).store("textboxlist:auto:value",c);this.list.adopt(a);if(this.options.highlight){$$(this.options.highlightSelector?a.getElements(this.options.highlightSelector):a).each(function(d){if(d.get("html")){this.method.highlight(d,b,this.options.insensitive,this.prefix+"-highlight");}},this);}if(this.options.mouseInteraction){a.setStyle("cursor","pointer").addEvents({mouseenter:function(){this.focus(a);}.bind(this),mousedown:function(d){d.stop();$clear(this.hidetimer);this.doAdd=true;}.bind(this),mouseup:function(){if(this.doAdd){this.addCurrent();this.currentInput.focus();this.search();this.doAdd=false;}}.bind(this)});if(!this.options.onlyFromValues){a.addEvent("mouseleave",function(){if(this.current==a){this.blur();}}.bind(this));}}},hide:function(a){this.hidetimer=(function(){this.hidePlaceholder();this.list.setStyle("display","none");this.currentSearch=null;}).delay(Browser.Engine.trident?150:0,this);},showPlaceholder:function(a){if(this.placeholder){this.placeholder.setStyle("display","block");if(a){this.placeholder.set("html",a);}}},hidePlaceholder:function(){if(this.placeholder){this.placeholder.setStyle("display","none");}},focus:function(a){if(!a){return this;}this.blur();this.current=a.addClass(this.prefix+"-result-focus");},blur:function(){if(this.current){this.current.removeClass(this.prefix+"-result-focus");this.current=null;}},focusFirst:function(){return this.focus(this.list.getFirst());},focusRelative:function(a){if(!this.current){return this;}return this.focus(this.current["get"+a.capitalize()]());},addCurrent:function(){var c=this.current.retrieve("textboxlist:auto:value");var a=this.textboxlist.create("box",c.slice(0,3));if(a){a.autoValue=c;if(this.index!=null){this.index.push(c);}this.currentInput.setValue([null,"",null]);a.inject($(this.currentInput),"before");}this.blur();return this;},navigate:function(c){switch(c.code){case Event.Keys.up:c.stop();(!this.options.onlyFromValues&&this.current&&this.current==this.list.getFirst())?this.blur():this.focusRelative("previous");break;case Event.Keys.down:c.stop();this.current?this.focusRelative("next"):this.focusFirst();break;case Event.Keys.enter:c.stop();if(this.current){this.addCurrent();}else{if(!this.options.onlyFromValues){var d=this.currentInput.getValue();var a=this.textboxlist.create("box",d);if(a){a.inject($(this.currentInput),"before");this.currentInput.setValue([null,"",null]);}}}}}});TextboxList.Autocomplete.Methods={standard:{filter:function(c,e,b,a){var g=[],f=new RegExp("\\b"+e.escapeRegExp(),b?"i":"");for(var d=0;d<c.length;d++){if(g.length===a){break;}if(c[d][1].test(f)){g.push(c[d]);}}return g;},highlight:function(d,c,b,a){var e=new RegExp("(<[^>]*>)|(\\b"+c.escapeRegExp()+")",b?"ig":"g");return d.set("html",d.get("html").replace(e,function(g,f,h){return(g.charAt(0)=="<")?g:'<strong class="'+a+'">'+h+"</strong>";}));}}};})();(function(){GrowingInput=new Class({Implements:[Options,Events],options:{min:0,max:null,startWidth:2,correction:15},initialize:function(e,d){this.setOptions(d);this.element=$(e).store("growing",this).set("autocomplete","off");this.calc=new Element("span",{styles:{"float":"left",display:"inline-block",position:"absolute",left:-1000}}).inject(this.element,"after");["font-size","font-family","padding-left","padding-top","padding-bottom","padding-right","border-left","border-right","border-top","border-bottom","word-spacing","letter-spacing","text-indent","text-transform"].each(function(f){this.calc.setStyle(f,this.element.getStyle(f));},this);this.resize();var c=this.resize.bind(this);this.element.addEvents({blur:c,keyup:c,keydown:c,keypress:c});},calculate:function(d){this.calc.set("html",d);var c=this.calc.getStyle("width").toInt();return(c?c:this.options.startWidth)+this.options.correction;},resize:function(){this.lastvalue=this.value;this.value=this.element.value;var c=this.value;if($chk(this.options.min)&&this.value.length<this.options.min){if($chk(this.lastvalue)&&(this.lastvalue.length<=this.options.min)){return;}c=a(this.value,this.options.min,"-");}else{if($chk(this.options.max)&&this.value.length>this.options.max){if($chk(this.lastvalue)&&(this.lastvalue.length>=this.options.max)){return;}c=this.value.substr(0,this.options.max);}}this.element.setStyle("width",this.calculate(c));return this;}});var b=function(d,c){return new Array(c+1).join(d);};var a=function(c,e,g,d){if(c.length>=e){return this;}g=g||" ";var f=b(g,e-c.length).substr(0,e-c.length);if(!d||d=="right"){return c+f;}if(d=="left"){return f+c;}return f.substr(0,(f.length/2).floor())+c+f.substr(0,(f.length/2).ceil());};})();