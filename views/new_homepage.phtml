<?php
function map_clean($func, $arr) {
	return array_filter(array_map($func, $arr));
}

// Taps
$last = (!empty($_t['last_tap'])) ? $_t['last_tap'][0] : null;

$inits = array(); $people = array();
if (is_array($_t['groups_bits'])) {
	function get_cids($bit) { return $bit['cid']; }
	$inits = map_clean("get_cids", $_t['groups_bits']);

	function get_uids($bit) { return $bit['uid']; }
	$people = map_clean("get_uids", $_t['groups_bits']);
}

$convos = array();
if (is_array($_t['active_convos'])) {
	function get_mids($bit) { return $bit['mid']; }
	$convos = map_clean("get_mids", $_t['active_convos']);
}

$groups = array(); $groups_online = array();
if (is_array($_t['your_groups'])) {
	function get_gids($bit) { return $bit['gid']; }
	//$groups = map_clean("get_gids", $_t['your_groups']);

	$count=0;
	foreach($_t['your_groups'] as $k => $v){
		$groups[$count] = $k;
		$count++;
	}
	foreach ($_t['your_groups'] as $group){
		$groups_online[$group['gid']] = $group['online_count'];
	}
}

$_SESSION['upic'] = $_t['user_pic_100'];

$all_your_groups_topic = "Aggregate feed of all of the groups";
$public_groups_topic = "This is a place where you can discover what's being said in real-time from all groups, even if you're not apart of them";
?>
<!doctype html>
<html>
<head>
	<? 
	$tpl_title = "Home";
	include(OK_HEADER);
	?>
	<script type="text/javascript" src="/views/scripts/tap.js"></script>
	<script type="text/javascript">
		window._vars = {
			uid: "<?= $_t['pcid'] ?>",
			uname: "<?= $_SESSION['uname'] ?>",
			stream: JSON.decode('<?= json_encode($inits) ?>'),
			convos: JSON.decode('<?= json_encode($convos) ?>'),
			people: JSON.decode('<?= json_encode($people) ?>'),
			groups: JSON.decode('<?= json_encode($groups) ?>'),
			groupsOnline: JSON.decode('<?= json_encode($groups_online) ?>'),
            sendTo: "public:public:0:0",
            filter: {
                gid: "0",
                info: {
                    name: "All Your Channels"
                }
            }
		};
	</script>
	<script type="text/javascript" src="/views/scripts/push.js"></script>
	<script type="text/javascript" src="/views/scripts/public.js"></script>
	<script type="text/javascript" src="/views/scripts/sidebar.js"></script>
	<script type="text/javascript" src="/views/scripts/filter.js"></script>
	<script type="text/javascript" src="/views/scripts/search.js"></script>
</head>
<body>
		<? include(MODAL_SIGNUP); ?>
		<script type="text/javascript" src="/views/scripts/modal_signup.js"></script>
				
<div id="wrapper">
		
	<? include(OK_TOPBAR); ?> 

	<div id="main">

			<? $show_lists = true; ?>
			<? include(OK_SIDEBAR); ?>

			<div id="content">

				<form id="tapbox" action="" class="section active">
					<div id="tapto">choose a group to tap</div>
					<span class="counter">240</span>
					<input id="taptext" tabindex="1" type="text" disabled="true" style="background:gray;">
					<button id="tapsend" tabindex="3" type="submit" class="">tap!</button>
					<span id="no-group-selected">You need to tap to a group!  Tap to a group by clicking on the group tab or searching for new groups to tap</span>
				</form>

				<div id="tapstream" class="section description">
					<div class="header">
						<a href="" id="streamer" class="floater" alt="pause live streaming" title="pause live streaming"></a>
						<a id="newtaps" href="" class="floater">This feed has 5 new taps! Click here to load them.</a>
						<h2 class="header-title">
							<img src="/images/flat/loader.gif" />
							<span class="title">feed</span>
						</h2>
						<span class="stream-name">All Your Groups <?php if(isset($_t['facebook_loginUrl'])): ?><a href="<?php echo $_t['facebook_loginUrl']; ?>">Login to facebook to see your other channels</a><?php endif; ?></span>
					</div>
					<div class="description" style="background: lightgrey; padding:15px;"><?= $all_your_groups_topic ?></div>
					<div class="body">
						<ul id="taps" class="stream">
							<?php
								if (!empty($_t['groups_bits'])):
									foreach($_t['groups_bits'] as $tap):
							?>
							<li id="tid_<?= $tap['cid'] ?>" class="container" 
								data-id="<?= $tap['cid'] ?>" data-uid="<?= $tap['uid'] ?>" data-user="<?= $tap['user'] ?>">
								<a href="/user/<?= $tap['uname'] ?>">
									<img class="avatar" alt="<?= $tap['uname'] ?>" src="/user_pics/<?= $tap['pic_100'] ?>" />
								</a>
								<p class="tap-from <?= ($tap['user_online'] || $tap['uname'] == $_SESSION['uname']) ? '" title="online"' : 'offline' ?>">
									<a href="/user/<?= $tap['uname'] ?>"><?= trim($tap['uname'])?></a>,
									<a href="/tap/<?= $tap['cid'] ?>" class="date" data-timestamp="<?= $tap['chat_timestamp_raw'] ?>">
										<?= $tap['chat_timestamp'] ?>
									</a>
									<a href="/channel/<?=$tap['symbol']?>" />
										<img class="aggr-favicons" src="/group_pics/<?=$tap['favicon']?>" title="<?=$tap['gname']?>" />
									</a>
								</p>
								<p class="tap-body">
									<?= $tap['chat_text'] ?>
								</p>
								<p class="tap-actions">
									<span class="tap-resp">
										<span class="indicator">Someone's replying..</span>
										<span class="last-resp">
											<strong><?= (!empty($tap['resp_uname'])) ? $tap['resp_uname'] . ":" : "" ?></strong>
											<span class="body ellipsis inblock"><?= $tap['last_resp'] ?></span>
										</span>
									</span>
									<a href="#" class="tap-resp-count" title="view responses">
											<span class="show-resp-count"><?= $tap['count'] ?></span>
											<span class="follow_button">Reply</span>
									</a>
								</p>
								<div class="responses">
									<ul class="chat">
									</ul>
									<input class="chatbox" type="text" />
									<div class="counter">240</div>
									<div class="overlay">type in your response and press enter.</div>
								</div>
							</li>
							<?php
									endforeach;
								endif;
							?>
							<li class="loadmore">
								<p>more...</p>
							</li>
						</ul>
					</div>
				</div>
			</div>





		</div>

		<div class="clarity"></div>
		<?include(OK_FOOTER)?>

	</div>
	<?include(JAVASCRIPT_TEMPLATES)?>
</body>
</html>
