<?php
function map_clean($func, $arr) {
	return array_filter(array_map($func, $arr));
}

// Taps
$last = (!empty($_t['last_tap'])) ? $_t['last_tap'][0] : null;

$inits = array();
$people = array();
if (is_array($_t['groups_bits'])) {
	function get_cids($bit) { return $bit['cid']; }
	$inits = map_clean("get_cids", $_t['groups_bits']);
	
	function get_uids($bit) { return $bit['uid']; }
	$people = map_clean("get_uids", $_t['groups_bits']);
}

$convos = array();
if (is_array($_t['active_convos'])) {
	function get_mids($bit) { return $bit['mid']; }
	$convos = map_clean("get_mids", $_t['active_convos']);
}

$groups = array(); $groups_online = array();
if (is_array($_t['your_groups'])) {
	function get_gids($bit) { return $bit['gid']; }
	$groups = map_clean("get_gids", $_t['your_groups']);
	foreach ($_t['your_groups'] as $group){
		$groups_online[$group['gid']] = $group['online_count'];
	}
}
?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta http-equiv="Content-Language" content="EN" />
<meta name="ROBOTS" content="ALL" />
<meta name="Copyright" content="Copyright (c) 2009 TAP" />
<meta http-equiv="imagetoolbar" content="false" />
<meta name="description" content="TAP communication platform" />
<meta name="keywords" content="real-time, search, TAP, microblogging, communication platform" />
<title>tap - alpha</title>
<link rel="shortcut icon" href="/images/cimages/favicon.ico" type="image/x-icon" />
<link rel="icon" href="/images/cimages/favicon.ico" type="image/x-icon" />
<link rel="stylesheet" href="/views/style_sheets/global.css" type="text/css" />
<link rel="stylesheet" href="/views/style_sheets/homepage.css" type="text/css" />
<link rel="stylesheet" href="/views/style_sheets/TextboxList.css" type="text/css" />
<link rel="stylesheet" href="/views/style_sheets/TextboxList.Autocomplete.css" type="text/css" />
<script type="text/javascript" src="/views/javascript/mootools-1.2.3-core-yc.js"></script>
<script type="text/javascript"src="/views/javascript/mootools-1.2.3.1-more.js"></script>
<script type="text/javascript" src="/views/javascript/textboxlist-complete.js"></script>
<script type="text/javascript" src="/views/javascript/mootools-tap.js"></script>
<script type="text/javascript" src="http://mark.tap.info:8000/static/Orbited.js"></script>
<script type="text/javascript">
Tap = window.Tap || {};
Tap.Vars = {
	pcid: "<?= $_t['pcid'] ?>".toInt(),
	uname: "<?= $_SESSION['uname'] ?>",
	currentTap: "<?= $last['cid'] ?>".toInt(),
	currentStream: JSON.decode('<?= json_encode($inits) ?>'),
	activeConvos: JSON.decode('<?= json_encode($convos) ?>'),
	people: JSON.decode('<?= json_encode($people) ?>'),
	groups: JSON.decode('<?= json_encode($groups) ?>'),
	groupsOnline: JSON.decode('<?= json_encode($groups_online) ?>')
};
// <?= $_GET['page'] ?>
</script>
<script type="text/javascript" src="/views/javascript/tap.push.js"></script>
<script type="text/javascript" src="/views/javascript/tap.home.js"></script>
<script type="text/javascript" src="/views/javascript/mpmetrics.js"></script>
<script type="text/javascript">
// Metrics
try { mpmetrics.init('<?= METRIC_KEY ?>');} catch(err) { alert(err) }
window.addEvent('domready', function(){
/*
	$(document.body).addEvents({
		'click:relay(a.suggestion-item)': function(e){
			e.stop();
			var self = this;
			mpmetrics.track('trending-click', {'group': this.getElement('strong').get('text')}, function(){
				window.location = self.get('href');
			});
		},
		'click:relay(li.group a)': function(){
			var self = this;
			var id = this.get('id');
			if (!id) return;
			mpmetrics.track('feed-change', {
				'group': (function(){
					if (id === 'gid_all') return 'All Groups';
					return self.getElement('a').get('title');
				})()
			});
		}
	});*/


	Tap.Home.addEvents({
		'sendTap': function(number){
			mpmetrics.track('send-tap', {
				'type': number !== 0 ? 'private' : 'public',
				'groups': number
			});
		},
		'loadResponses': function(){
			mpmetrics.track('view-responses', {});
		},
		'sendResponse': function(){
			mpmetrics.track('send-responses', {});
		},
		'searchFeed': function(keyword){
			mpmetrics.track('search-feed', {'keyword': keyword});
		}
	});
});
</script>
</head>

<body>

	<? include(HEADER_CLEAN); ?>

	<div id="tap-feed-outside-more">
		<p style="margin-bottom:5px">Allow messages from this groups:</p>
		<p>
			<input type="text" name="outside-from" alt="Choose sources.." />
		</p>
		<p style="clear:both;">
			<a href="#" id="tap-feed-outside-set">Save</a>
		</p>
	</div>

	<div id="main">

		<div id="sidebar-left" class="sidebar">
			<div id="groups" class="section">
				<div class="section-head section-head-home">
					<h1>Popular Groups</h1>
				</div>
				<div class="section-body">
					<ul class="suggested-groups">
						<?php foreach($_t['trending_groups'] as $random): ?>
						<li class="list-item">
							<p class="name">
								<a class="suggestion-item" title="<?= $random['gname'] ?>" href="/group/<?= $random['symbol'] ?>">
								<img src="/group_pics/<?= $random['pic_36'] ?>">
								<?php
									$gname = $random['gname'];
									echo stripslashes((strlen($gname) < 15) ? $gname : substr($gname, 0, 15) . '...');
								?>
								</a>
							</p>
							<p class="focus"><?= $random['count'] ?> Taps</p>
						</li>
						<?php endforeach; ?>
						<li class="list-item" style="height:30px; margin-top:20px">
							<strong><a class="side-link" href="/groups" title="Create/Join New Groups">Create/Join New Groups</a></strong>
						</li>
					</ul>
					<div class="clarity"></div>
				</div>
			</div>
		</div>

		<div id="content">
			
			<div id="tap-box" class="section">
				<div id="tap-box-counter">240</div>
				<input type="text" id="tap-box-msg" maxlength="240" alt="Start tapping by writing a message here." />
				<div id="tap-box-more">
					<input type="text" id="tap-box-people" alt="Add some groups who'll receive your tap!" />
					<a id="tap-box-send" href="#">tap!</a>
					<div style="clear:both"></div>
				</div>
			</div>

			<div id="tap-yours" class="section">
				<div class="section-head">
					<h1>
						Your Last Tap
					</h1>
				</div>
				<div class="section-body feed">
					<ul id="your-stream" class="tap-stream">
						<?php if ($last == null): ?>
						<li class='welcome_tap'>
							<h1 style="font-size:14px; font-weight:bold; margin-bottom: 5px; color: #4F9CDF;">Welcome To Tap!</h1>
							<p style="margin-bottom: 10px;">Tap allows you to connect with people around you and stay informed about topics you're interested in.</p>
							<p style="margin-bottom: 10px;"></p>
							<p style="margin-bottom: 10px;">You can start by updating your <a href="/profile"><strong>profile pic</strong></a>, joining a <a href="/groups"><strong>group</strong></a>, or you can send a tap right now using the TapBox above. If you get stuck, check out the <a href="/help"><strong>Help</strong></a> section, or send a tap to <strong>Support</strong>.</p>
							<p style="margin-bottom: 10px;"><strong>Keep on tapping!</strong></p>
						</li>
						<?php else: ?>
						<li id="yid_<?= $last['cid'] ?>">
							<img src="/user_pics/<?= $last['pic_100'] ?>" class="avatar" title="<?= $last['uname'] ?>" alt="<?= $last['uname'] ?>" rel="<?= $last['uid'] ?>" />
							<div class="tap-actions">
								<span class="tap-views">Viewers: 
									<strong>
									<?= (!empty($last['viewer_count'])) ? $last['viewer_count'] : '0' ?>
									</strong>
								</span>
								<a class="tap-respond <?= empty($last['count']) ? 'noresp' : '' ?>" href="#">
									Respond <span class="tap-respond-count">(<?= $last['count'] ?>)</span>
								</a>
								<p class="tap-respond-last <?= empty($last['count']) ? 'noresp' : '' ?>">
									<strong>
										<?= (!empty($last['resp_uname'])) ? $last['resp_uname'] . ":" : "" ?>
									</strong>
									<span>
										<?php
											$last_rep = $last['last_resp'];
											echo (strlen($last_rep) < 70) ? $last_rep : substr($last_rep, 0, 70) . '...';
										?>
									</span>
								</p>
							</div>
							<div class="tap-body">
								<p class="tap-info">
									<span class="tap-from">
										<a href="/user/<?= $last['uname'] ?>" title="">
										<?= $last['fname'] . " " . $last['lname'] ?>
										</a>
										<img src="/images/icons/bullet_green.png" title="User Online" alt="User Online" class="online-indicator uol_<?= $last['uid'] ?>" />
									</span>
									<a href="/tap/<?= $last['cid'] ?>">
										<span class="tap-time <?= $last['chat_timestamp_raw'] ?>"><?= $last['chat_timestamp'] ?></span>
									</a>
									<span class="tap-typing"></span>
								</p>
								<p>
									<span class="tap-msg"><?= $last['chat_text'] ?></span>
								</p>
							</div>
							<div class="tap-response-box clarity">
								<div class="tap-response-counter">240</div>
								<ul class="tap-chat <?= empty($last['count']) ? 'noresp' : '' ?>">
								</ul>
								<input type="text" class="tap-response" style="width:420px" maxlength="240" alt="Respond to this tap." />
								<!-- <a href="#">Respond</a> or  --><a class="tap-respond-cancel" href="#">Close</a>
							</div>
							<div class="clarity"></div>
						</li>
						<?php endif; ?>
					</ul>
				</div>
			</div>

			<div id="tap-feed" class="section">
				<div class="section-head">
					<h1>
						<input type="text" id="tap-feed-search" alt="Search through feed." />
						<!-- <span id="tap-feed-outside-drop"></span> -->
						<!-- <span id="tap-feed-outside">Outside: Off</span> -->
						<span id="taps-responded">Taps You've Responded To</span>
						<span style="clear:right"></span>
						<img id="tap-feed-icon" src="/group_pics/36wh_default_group.gif" style="float:left; margin-right:10px; height: 20px; width: 20px" />
						<span id="tap-feed-name">Groups Feed</span>
						<img src="/images/loading.gif" id="loading-indicator" style="display:none" />
					</h1>
				</div>
				<div class="section-body feed">
					<div id="tap-notify"></div>
					<ul id="main-stream" class="tap-stream">
						<?php
							if (!empty($_t['groups_bits'])):
								foreach($_t['groups_bits'] as $bit):
						?>
						<li id="tid_<?= $bit['cid'] ?>">
							<img src="/user_pics/<?= $bit['pic_100'] ?>" class="avatar" alt="<?= $bit['uname'] ?>" rel="<?= $bit['uid'] ?>" />
							<div class="tap-actions">
								<span class="tap-views">Viewers: 
									<strong>
									<?= (!empty($bit['viewer_count'])) ? $bit['viewer_count'] : '0' ?>
									</strong>
								</span>
								<a class="tap-respond <?= empty($bit['count']) ? 'noresp' : '' ?>" href="#">
									Respond <span class="tap-respond-count">(<?= $bit['count'] ?>)</span>
								</a>
								<p class="tap-respond-last <?= empty($bit['count']) ? 'noresp' : '' ?>">
									<strong>
										<?= (!empty($bit['resp_uname'])) ? $bit['resp_uname'] . ":" : "" ?>
									</strong>
									<span>
										<?php
											$last_rep = $bit['last_resp'];
											echo (strlen($last_rep) < 70) ? $last_rep : substr($last_rep, 0, 70) . '...';
										?>
									</span>
								</p>
							</div>
							<div class="tap-body">
								<p class="tap-info">
									<span class="tap-from">
										<a href="/user/<?= $bit['uname'] ?>" title="">
										<?= $bit['fname'] . " " . $bit['lname'] ?>
										</a>
										<img 
											src="/images/icons/bullet_<?= $bit['uid'] == $_SESSION['uid'] || $bit['user_online'] ? 'green' : 'white'  ?>.png" 
											alt="User <?= $bit['uid'] == $_SESSION['uid'] || $bit['user_online'] ? 'Online' : 'Offline'  ?>" 
											class="online-indicator uol_<?= $bit['uid'] ?>" 
										/>
									</span>
									<a href="/tap/<?= $bit['cid'] ?>">
										<span class="tap-time <?= $bit['chat_timestamp_raw'] ?>"><?= $bit['chat_timestamp'] ?></span>
									</a>
									<span class="tap-typing"></span>
								</p>
								<p>
									<span class="tap-msg"><?= $bit['chat_text'] ?></span>
								</p>
							</div>
							<div class="tap-response-box clarity">
								<div class="tap-response-counter"></div>
								<ul class="tap-chat <?= empty($bit['count']) ? 'noresp' : '' ?>">
								</ul>
								<input type="text" class="tap-response" style="width:420px" maxlength="240" alt="Respond to this tap." />
								<!-- <a href="#">Respond</a> or  --><a class="tap-respond-cancel" href="#">Close</a>
							</div>
							<div class="clarity"></div>
						</li>
						<?php
								endforeach;
							else:
						?>
						<li class="noresults">
							<p>This feed is too silent. Try sending a tap!</p>
						</li>
						<?php
							endif;
						?>
					</ul>
				</div>
			</div>
			
		</div>
		
		<div id="sidebar-right" class="sidebar">
			<div class="section-head-homepage">
				<h1>Feeds</h1>
			</div>
			<div class="section">
				<div id="home-section-body"  class="section-body">
					<ul>
						<li id="gid_public" class="group">
							<span class="counter"></span>
							<img src="/images/icons/transmit.png" />
							<strong><a href="#" title="Public Feed">Public Taps</a></strong>
						</li>
						<li class="group">
							<span class="counter"></span>
							<img src="/images/icons/folder.png" />
							<strong id="archived-taps"><a href="#" title="Archived taps">Archived Taps</a></strong>
						</li>
						<li id="gid_all" class="group selected">
							<span class="counter"></span>
							<img src="/images/icons/house.png" />
							<strong><a href="#" title="Groups Feed">All Your Groups <span class="unread-counter">(0)</span></a></strong>
						</li>
						<?php foreach ($_t['your_groups'] as $group): ?>
						<li id="gid_<?= $group['gid'] ?>" class="group">
							<? if($group['type'] == 0): ?>
							<img src="/images/icons/group.png" /> 
							<? endif ?>
							<? if($group['type'] == 1): ?>
							<img src="/images/icons/book.png" /> 
							<? endif ?>
							<? if($group['type'] == 2): ?>
							<img src="/images/icons/building.png" /> 
							<? endif ?>
							<? if($group['type'] == 3): ?>
							<img src="/images/icons/rosette.png" /> 
							<? endif ?>

							<a href="#<?= $group['display_symbol'] ?>" grsymbol="<?= $group['symbol'][0] ?>" title="<?= $group['gname'] ?> (<?= $group['message_count'] ?>)"><?= $group['display_symbol'] ?> <span class="unread-counter">(0)</span></a>
							<a class="add-tap-to" grtype="<?= $group['type'] ?>" href="#" title="Tap this group!">+</a>
						</li>
						<?php endforeach; ?>
						<li style="margin-top:20px">
							<span class="counter"></span>
							<strong><a href="/groups" title="Create/Join New Groups">Create/Join New Groups</a></strong>
						</li>
					</ul>
				</div>
			</div>
			
			<div class="section">
				<div class="section-head-homepage">
					<h1>Active Convos</h1>
				</div>
				<div class="section-body">
					<ul id="active-convos-list">
						<?php 
							if (!empty($_t['active_convos'])):
								$active_convos = array_reverse($_t['active_convos']);
								foreach ($active_convos as $convo): 
						?>
						<li id="aid_<?= $convo['mid'] ?>" class="convo">
							<strong><a href="#" class="change-convo"><?= $convo['uname'] ?></a></strong>
							<span style="font-size:10px">
							<?php
								$chat_text = $convo['chat_text'];
								echo stripslashes((strlen($chat_text) < 20) ? $chat_text : substr($chat_text, 0, 20) . '...');
							?> 
							(<span class="convo-count"><?= $convo['resp_count'] ?></span>)
							</span>
							<a href="#" class="remove-convo" title="Remove Conversation">&ndash;</a>
						</li>
						<?php 
								endforeach;
							else: 
						?>
						<li class="no-convos">
							<strong>No Active Conversations</strong>
						</li>
						<?php 
							endif; 
						?>
					</ul>
				</div>
			</div>
		</div>
		
	</div>
	
	<div id="templates">
		<ul id="template-bit">
			<# for (var x = this.reverse().length; x--;) { var bit = this[x]; #>
			<li id="tid_<#: bit.cid #>">
				<img src="/user_pics/<#: bit.pic_100 #>" class="avatar" alt="<#: bit.uname #>" rel="<#: bit.uid #>"  />
				<div class="tap-actions">
					<span class="tap-views">Viewers: 
						<strong>
							<#: bit.viewer_count || 0 #>
						</strong>
					</span>
					<# if (bit.count) { #>
					<a class="tap-respond" href="#">
					<# } else { #>
					<a class="tap-respond noresp" href="#">
					<# } #>
						Respond <span class="tap-respond-count">(<#: bit.count #>)</span>
					</a>
					<# if (bit.count) { #>
					<p class="tap-respond-last">
					<# } else { #>
					<p class="tap-respond-last noresp">
					<# } #>
						<strong>
							<#: bit.resp_uname ? bit.resp_uname + ":" : "" #>
						</strong>
						<# if (bit.last_resp) { #>
							<#: ((bit.last_resp.length < 70) ? bit.last_resp : bit.last_resp.substring(0, 70) + "...").linkify() #>
						<# } #>
					</p>
				</div>
				<div class="tap-body">
					<p class="tap-info">
						<span class="tap-from">
							<a href="/user/<#: bit.uname #>" title="">
							<#: [bit.fname, bit.lname].join(" ") #>
							</a>
							<# if (bit.uid == "<?= $_SESSION['uid'] ?>" || bit.user_online == "1"){ #>
							<img 
								src="/images/icons/bullet_green.png" 
								alt="User Online" 
								class="online-indicator uol_<#: bit.uid #>" 
							/>
							<# } else { #>
								<img 
									src="/images/icons/bullet_white.png" 
									alt="User Offline" 
									class="online-indicator uol_<#: bit.uid #>" 
								/>
							<# } #>
						</span>
						<a href="/tap/<#: bit.cid #>">
							<span class="tap-time <#: bit.chat_timestamp_raw #>"><#: bit.chat_timestamp #></span>
						</a>
						<span class="tap-typing"></span>
					</p>
					<p>
						<span class="tap-msg"><#: bit.chat_text.linkify() #></span>
					</p>
				</div>
				<div class="tap-response-box clarity">
					<div class="tap-response-counter"></div>
					<# if (bit.count) { #>
					<ul class="tap-chat">
					<# } else { #>
					<ul class="tap-chat noresp">
					<# } #>
					</ul>
					<input type="text" class="tap-response" style="width:420px" maxlength="240" alt="Respond to this tap." />
					<!-- <a href="#">Respond</a> or  --><a class="tap-respond-cancel" href="#">Close</a>
				</div>
				<div class="clarity"></div>
			</li>
			<# } #>
		</ul>
		<ul>
			<li id="no-taps" class="noresults">
				<p>There doesn't seem to be anything here.</p>
			</li>
			<li id="no-results" class="noresults">
				<p>
					No taps match your search keyword.
					<a href="#" class="reset-feed">Show all taps.</a>
				</p>
			</li>
		</ul>
	</div>
	
	<? include(ANALYTICS); ?>

</body>
</html>
