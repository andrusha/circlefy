<?php
$logged = (!empty($_SESSION['uid']));
if ($no_group) header('location:/');

function map_clean($func, $arr) {
    return array_filter(array_map($func, $arr));
}

$inits = array();
$people = array();
if (is_array($user_bits)) {
    function get_cids($bit) {
        return $bit['cid'];
    }

    $inits = map_clean("get_cids", $user_bits);
    function get_uids($bit) {
        return $bit['uid'];
    }

    $people = map_clean("get_uids", $user_bits);
}

$groups = $gid;

function map_admins($admin) {
    return $admin['uname'];
}

$admin = in_array($_SESSION['uname'], array_map("map_admins", !empty($admins) ? $admins : array()));

?>
<!doctype html>
<html>
<head>
	<? $tpl_title = "Channel " . $symbol; ?>
	<?include(OK_HEADER)?>
    <link rel="shortcut icon" href="http://tap.info/group_pics/<?=$favicon?>"/>
    <link title="" type="application/rss+xml" rel="alternate" href="http://<?=$_SERVER['SERVER_NAME']?>/rss_<?=$symbol;?>.xml"/>
    <script type="text/javascript" src="/views/scripts/tap.js"></script>
    <script type="text/javascript">
        window._vars = {
            uid: "<?= $pcid ?>",
            uname: "<?= $_SESSION['uname'] ?>",
            stream: JSON.decode('<?= json_encode($inits) ?>'),
            convos: [],
            people: JSON.decode('<?= json_encode($people) ?>'),
            groups: JSON.decode('<?= json_encode($groups) ?>'),
            sendTo: "<?= $gname ?>:<?= $symbol ?>:0:<?= $gid ?>",
            filter: {
                gid: "<?= $gid ?>",
                info: {
                    name: "<?= $gname ?>",
                    symbol: "<?= $symbol ?>"
                }
            }
        };
    </script>
    <script type="text/javascript" src="/views/scripts/push.js"></script>
    <script type="text/javascript" src="/views/scripts/public.js"></script>

	<script type="text/javascript" src="/views/scripts/filter.js"></script> 
	<script type="text/javascript" src="/views/scripts/members.js"></script> 

	<script type="text/javascript" src="/views/scripts/search.js"></script> 
	<script type="text/javascript" src="/views/scripts/group_mod.js"></script> 
	<script type="text/javascript" src="/views/scripts/infobox.js"></script> 

<? /*	<script type="text/javascript" src="/views/scripts/public_group.js"></script>  */ ?>

</head>
<body>

<?php if (!$ok_user): ?>
    <? include(MODAL_SIGNUP); ?>
    <script type="text/javascript" src="/views/scripts/modal_signup.js"></script>
<?php endif; ?>

<div id="wrapper">

<? include(OK_TOPBAR); ?>

<div id="main">

<? ob_start(); ?>
    <div class="sideinfo section container">
        <h2>
            <span id="tab-name">admins</span>
        </h2>
        <ul class="panel">
        <?php
        if ($admins):
            foreach ($admins as $admin):
                ?>
                    <a href="/user/<?=$admin['uname']?>">
                        <li class="panel-item-public-admin" title="<?=$admin['uname']?>">
                            <span class="count"></span>
                            <img class="online-img" src="/user_pics/<?=$admin['small_pic']?>"/>&nbsp;
                        </li>
                    </a>
                <?php
                                                endforeach;
        else:
            ?>
                <li class="notify">
                    This channel has no admins.
                </li>
            <?php
                                        endif;
        ?>
        </ul>
    </div>

    <div class="sideinfo section container">
        <h2>
            <a id="list-action" href="#" class="all">all members</a>
            <span id="tab-name">top members</span>
        </h2>
        <li id="online-only-checkbox"><label>Online Only</label><input id="online-checked" type="checkbox" checked></li>
        <ul id="member-panel" class="panel selected">
        <?php
                                    if (!empty($popular_members)):
            foreach ($popular_members as $member):
                ?>
<a href="/user/<?=$member['member']?>"/>
<li class="panel-item-public-group">
<img class="online-img" src="/user_pics/<?=$member['small_pic']?>"/>
<? /* <span class="top-member-count"/><?=$member['count']?></span> */ ?>
<? /* if (strlen($member['member']) > 7) $member_name = substr($member['member'], 0, 7) . '..'; else $member_name = $member['member'] */ ?>
<? /* <p class="top-member-member"/><?=$member_name?></p> */ ?>
</li>
</a>
                <?php
                                                endforeach;
        else:
            ?>
                <li class="notify">
                    This channel has no top members.
                </li>
            <?php
                                        endif;
        ?>
        </ul>
    </div>
<?
$add_sidebar = ob_get_clean();
$show_search = true;
include(OK_SIDEBAR); 
?>

<?php
            /* DYNAMIC STYLES */
if ($topbg == 'dark') {
    $color_name = '#FFFA00';
    $color_topbg = '#3C3C3C';
    $join = 'lightgreen';
} else {
    $color_name = '#3C3C3C';
    $color_topbg = 'white';
    $join = 'green';
}
?>
    <div id="content">
        <div id="infobox" class="pubgroup section container" style="background:<?=$color_topbg?>;">

        <?php if ($status == 1): ?>
            <button data-id="<?= $gid ?>" class="leave">unfollow channel</button>
        <?php elseif ($logged): ?>
            <?php if ($private): ?>
                <?php if ($requested): ?>
                    <button data-id="<?= $gid ?>" class="waiting">waiting accept</button>
                <?php  else: ?>
                    <button data-id="<?= $gid ?>" class="request">request to follow channel</button>
                <?php  endif; ?>
            <?php  else: ?>
                <button data-id="<?= $gid ?>" class="join">follow channel</button>
            <?php endif; ?>
        <?php  else: ?>
            <button data-id="<?= $gid ?>" class="login">login to follow</button>
        <?php endif; ?>

            <img src="/group_pics/<?= $group_pic_med ?>" class="group-avatar"/>

            <h2>
            <?= ($admin ? '<span class="moderator-title">&#10070;</span> ' : '') ?> <span
                    style="color:<?=$color_name?>;"><?= $gname ?></span> <span
                    class="nick"><?= $symbol ?></span>
            </h2>

            <p class="stats">
                <strong class="count-one"><?= (!empty($member_count)) ? $member_count : '0' ?></strong>
                Members joined,
                <strong><?=$taps_count?></strong> Taps sent, and
                <strong><?=$responses_count?></strong> Responses received.
            </p>

            <div class="description">
            <?=$descr?>
            </div>

        <? if ($type == 3 || $type == 1): ?>
            <img style="float:right;" src="/images/icons/tick.png" title="Verified Official Community"/>
        <? endif; ?>
            <span style="float:right;display:block;color:<?=$join?>;opacity:0;" class="positive-click">Joined!</span>
            <span style="float:right;display:block;color:red;opacity:0;" class="waiting-click">Waiting!</span>
            <span style="float:right;display:block;color:red;opacity:0;" class="negative-click">Come back! :(</span>
        </div>

        <div id="tapstream" class="section description">
            <div class="header"> 
                <a href="" id="streamer" class="floater" alt="pause live streaming" title="pause live streaming"></a>
                <a href="#" id="anon_filter" class="floater" alt="Filter guests" title="Filter guests">Registred users</a>
                <a id="newtaps" href="" class="floater">This feed has 5 new taps! Click here to load them.</a>

                <h2 class="header-title">
                    <img src="/images/flat/loader.gif"/>
                    <span class="title">feed</span>
                </h2>
                <span class="stream-name" style="float: left">
                    <img class="favicon-stream-title" src="/group_pics/<?=$favicon?>"/> &nbsp;<?= $gname ?>
                </span>
				
                <span class="visitor_count" title="viewers online/total" style="float: left">
                <? if (ADMIN_GLOBAL || $enable_admin): ?>
                    <span class="admin">
                        <a href="/channel_edit?channel=<?=$symbol?>">
                            Manage Channel
                        </a>
                    </span>
                <? endif; ?>
                    <span class="viewers_online"><?=$online_count?></span>
                    / 
                    <span id="total-member-count">
                        <a href="#">
                        <span class="count-one"><?=$total_count?></span>
                        </a>
                    </span>
                </span>

                <ul class="like-buttons">
                    <li style="width: 60px; margin-top:2px; margin-left: 10px;">
                        <iframe 
                        src="http://api.tweetmeme.com/button.js?url=<?php echo urlencode("http://" . $_SERVER["HTTP_HOST"] . $_SERVER["REQUEST_URI"]);?>&amp;style=compact"></iframe>
                    </li>       

                    <li style="width: 100px;">
                        <iframe 
                        src="http://www.facebook.com/plugins/like.php?href=<?php echo urlencode("http://" . $_SERVER["HTTP_HOST"] . $_SERVER["REQUEST_URI"]);?>&amp;layout=button_count&amp;show_faces=true&amp;width=80&amp;action=like&amp;font=arial&amp;colorscheme=dark&amp;height=21"
                        scrolling="no" 
                        frameborder="0"
                        allowTransparency="true"></iframe>
                    </li>

                </ul>

            </div>


            <form id="tapbox" action="">
                <div id="tapto">
                    tap <?= strtolower($gname) ?>..
                </div>
                <span class="counter">240</span>
                <input id="taptext" tabindex="1" type="text">
                <button id="tapsend" tabindex="3" type="submit">tap!</button>

                <?php if ($private): ?>
                    <?php if ($status == -1): ?>
                        <div style="color:red;margin-top:20px;">This channel is private, you can request to join a conversation.</div>
                    <?php elseif ($status == 0): ?>
                        <div style="color:red;margin-top:20px;">Please wait for the channel owner to accept your request.</div>
                    <?php endif; ?>
                <?php endif; ?>
            </form>


            <div class="body">
                <?php
                    $_taps = $user_bits;
                    include(TAP_STREAM);
                ?>
            </div>
        </div>

    </div>

</div>
</div>
<?include(OK_FOOTER)?>
<?include(JAVASCRIPT_TEMPLATES)?>

<?php if (!$logged && false): ?>
<? include(FBCONNECT_BOTTOM) ?>
<?php endif; ?>
</body>
</html>
